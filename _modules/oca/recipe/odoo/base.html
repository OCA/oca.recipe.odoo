
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>oca.recipe.odoo.base &#8212; Odoo buildout recipe 1.9.3.dev0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-sphinx.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html"><span><img src="../../../../_static/logo.png"></span>
          Odoo buildout recipe</a>
        <span class="navbar-text navbar-version pull-left"><b>1.9</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../../index.html">Home</a></li>
                <li><a href="https://odoo-community.org">OCA</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../first_steps.html">First steps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../first_steps.html#how-to-create-and-bootstrap-a-buildout">How to create and bootstrap a buildout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../first_steps.html#example-openerp-7-0-buildouts">Example OpenERP 7.0 buildouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../first_steps.html#example-openerp-6-1-buildout-with-a-custom-addon">Example OpenERP 6.1 buildout with a custom addon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../first_steps.html#example-openerp-6-0-buildout-server-and-clients">Example OpenERP 6.0 buildout (server and clients)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../first_steps.html#continuously-tested-examples">Continuously tested examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../first_steps.html#other-sample-buildouts">Other sample buildouts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../configuration.html">Configuration reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../configuration.html#the-buildout-configuration-file-and-parts">The buildout configuration file and parts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../configuration.html#odoo-recipes">Odoo recipes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../configuration.html#options-for-assembly-and-source-management">Options for assembly and source management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../configuration.html#options-for-buildout-relocation">Options for buildout relocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../configuration.html#odoo-options">Odoo options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../configuration.html#options-for-executables-generation-and-serving">Options for executables generation and serving</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../configuration.html#options-for-development-qa-and-introspection">Options for development, QA and introspection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../configuration.html#options-for-download-and-caching-strategies">Options for download and caching strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../configuration.html#options-for-release-and-packaging">Options for release and packaging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scripts.html">Odoo Scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../scripts.html#use-cases">Use cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../scripts.html#declaring-odoo-scripts">Declaring Odoo Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../scripts.html#interactive-consoles">Interactive Consoles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../scripts.html#writing-odoo-scripts">Writing Odoo Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../scripts.html#upgrade-scripts">Upgrade scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../scripts.html#startup-scripts">Startup scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../scripts.html#list-of-internal-entry-points">List of internal entry points</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dev_prod_workflow.html">Full development to production example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../dev_prod_workflow.html#common-setup">Common setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../dev_prod_workflow.html#developer-s-setup">Developerâ€™s setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../dev_prod_workflow.html#release-and-packaging">Release and packaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../dev_prod_workflow.html#deployment-with-a-server-local-configuration-file">Deployment with a server-local configuration file</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">For contributors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../contributing.html#source-and-tracking">Source and tracking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../contributing.html#using-a-development-version">Using a development version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../contributing.html#development-setup">Development setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../contributing.html#building-documentation">Building documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../contributing.html#coding-style">Coding style</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../contributing.html#launching-static-analysis-and-unit-tests">Launching static analysis and unit tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../contributing.html#integration-tests">Integration tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../contributing.html#continuous-integration">Continuous integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devnotes/index.html">Development notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../devnotes/git-sparse-shallow.html">Git shallow clones and selective branch fetching</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.html">oca.recipe.odoo Package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.html#id1"><code class="xref py py-mod docutils literal notranslate"><span class="pre">oca.recipe.odoo</span></code> Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.html#module-oca.recipe.odoo.base"><code class="xref py py-mod docutils literal notranslate"><span class="pre">base</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.html#module-oca.recipe.odoo.devtools"><code class="xref py py-mod docutils literal notranslate"><span class="pre">devtools</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.html#module-oca.recipe.odoo.server"><code class="xref py py-mod docutils literal notranslate"><span class="pre">server</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.html#module-oca.recipe.odoo.testing"><code class="xref py py-mod docutils literal notranslate"><span class="pre">testing</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.html#module-oca.recipe.odoo.utils"><code class="xref py py-mod docutils literal notranslate"><span class="pre">utils</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.html#subpackages">Subpackages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.runtime.html">runtime Subpackage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.runtime.html#module-oca.recipe.odoo.runtime"><code class="xref py py-mod docutils literal notranslate"><span class="pre">runtime</span></code> Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.runtime.html#module-oca.recipe.odoo.runtime.session"><code class="xref py py-mod docutils literal notranslate"><span class="pre">session</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.runtime.html#module-oca.recipe.odoo.runtime.upgrade"><code class="xref py py-mod docutils literal notranslate"><span class="pre">upgrade</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.runtime.html#module-oca.recipe.odoo.runtime.start_odoo"><code class="xref py py-mod docutils literal notranslate"><span class="pre">start_openerp</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.runtime.html#module-oca.recipe.odoo.runtime.test_odoo"><code class="xref py py-mod docutils literal notranslate"><span class="pre">test_openerp</span></code> Module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.vcs.html">vcs Subpackage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.vcs.html#module-oca.recipe.odoo.vcs"><code class="xref py py-mod docutils literal notranslate"><span class="pre">vcs</span></code> Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.vcs.html#module-oca.recipe.odoo.vcs.base"><code class="xref py py-mod docutils literal notranslate"><span class="pre">base</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.vcs.html#module-oca.recipe.odoo.vcs.bzr"><code class="xref py py-mod docutils literal notranslate"><span class="pre">bzr</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.vcs.html#module-oca.recipe.odoo.vcs.git"><code class="xref py py-mod docutils literal notranslate"><span class="pre">git</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.vcs.html#module-oca.recipe.odoo.vcs.hg"><code class="xref py py-mod docutils literal notranslate"><span class="pre">hg</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.vcs.html#module-oca.recipe.odoo.vcs.svn"><code class="xref py py-mod docutils literal notranslate"><span class="pre">svn</span></code> Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../apidoc/oca.recipe.odoo.vcs.html#module-oca.recipe.odoo.vcs.testing"><code class="xref py py-mod docutils literal notranslate"><span class="pre">testing</span></code> Module</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for oca.recipe.odoo.base</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">basename</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">setuptools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ConfigParser</span> <span class="kn">import</span> <span class="n">ConfigParser</span><span class="p">,</span> <span class="n">RawConfigParser</span>  <span class="c1"># Python 2</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span><span class="p">,</span> <span class="n">RawConfigParser</span>  <span class="c1"># Python 3</span>
<span class="kn">import</span> <span class="nn">distutils.core</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># Python &lt; 2.7</span>
    <span class="kn">from</span> <span class="nn">ordereddict</span> <span class="kn">import</span> <span class="n">OrderedDict</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">zc.buildout.easy_install</span> <span class="kn">import</span> <span class="n">MissingDistribution</span>
<span class="kn">from</span> <span class="nn">zc.buildout</span> <span class="kn">import</span> <span class="n">UserError</span>
<span class="kn">from</span> <span class="nn">zc.buildout.easy_install</span> <span class="kn">import</span> <span class="n">VersionConflict</span>
<span class="kn">from</span> <span class="nn">zc.buildout.easy_install</span> <span class="kn">import</span> <span class="n">Installer</span>

<span class="kn">from</span> <span class="nn">zc.buildout.easy_install</span> <span class="kn">import</span> <span class="n">IncompatibleConstraintError</span>

<span class="kn">import</span> <span class="nn">zc.recipe.egg</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">httplib</span>  <span class="c1"># Python 2</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">httplib</span>  <span class="c1"># Python 3</span>
<span class="kn">from</span> <span class="nn">email</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">email_utils</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlretrieve</span>  <span class="c1"># Python 2</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>  <span class="c1"># Python 3</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span>  <span class="c1"># Python 2</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>  <span class="c1"># Python 3</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">vcs</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">option_splitlines</span><span class="p">,</span> <span class="n">option_strip</span><span class="p">,</span> <span class="n">conf_ensure_section</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="nb">next</span>


<div class="viewcode-block" id="rfc822_time"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.rfc822_time">[docs]</a><span class="k">def</span> <span class="nf">rfc822_time</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse RFC 2822-formatted http header and return a time int.&quot;&quot;&quot;</span>
    <span class="n">email_utils</span><span class="o">.</span><span class="n">mktime_tz</span><span class="p">(</span><span class="n">email_utils</span><span class="o">.</span><span class="n">parsedate_tz</span><span class="p">(</span><span class="n">h</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_content_type"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.get_content_type">[docs]</a><span class="k">def</span> <span class="nf">get_content_type</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the mimetype of the HTTP message.</span>
<span class="sd">    This is a helper to support Python 2 and 3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span></div>


<div class="viewcode-block" id="MainSoftware"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.MainSoftware">[docs]</a><span class="k">class</span> <span class="nc">MainSoftware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Placeholder to represent the main software instead of an addon location.</span>

<span class="sd">    Should just have a singleton instance: :data:`main_software`,</span>
<span class="sd">    whose meaning depends on the concrete recipe class using it.</span>

<span class="sd">    For example, in :class:`oca.recipe.odoo.server.ServerRecipe`,</span>
<span class="sd">    :data:`main_software` represents the OpenObject server or the Odoo</span>
<span class="sd">    standard distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Main Software&#39;</span></div>


<span class="n">main_software</span> <span class="o">=</span> <span class="n">MainSoftware</span><span class="p">()</span>

<span class="n">GP_VCS_EXTEND_DEVELOP</span> <span class="o">=</span> <span class="s1">&#39;vcs-extend-develop&#39;</span>
<span class="n">GP_DEVELOP_DIR</span> <span class="o">=</span> <span class="s1">&#39;develop-dir&#39;</span>

<span class="n">WITH_ODOO_REQUIREMENTS_FILE_OPTION</span> <span class="o">=</span> <span class="s1">&#39;apply-requirements-file&#39;</span>


<div class="viewcode-block" id="pip_version"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.pip_version">[docs]</a><span class="k">def</span> <span class="nf">pip_version</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">pip</span>
    <span class="c1"># we don&#39;t use pip or setuptools APIs for that to avoid going</span>
    <span class="c1"># in a swath of instability.</span>
    <span class="c1"># TODO we could try and use the version class from runtime.session</span>
    <span class="c1"># (has the advantage over pkf_resources&#39; of direct transparent</span>
    <span class="c1"># comparison to tuples), but that&#39;d introduced logical deps problems</span>
    <span class="c1"># that I don&#39;t want to solve right now.</span>

    <span class="n">pip_version</span> <span class="o">=</span> <span class="n">pip</span><span class="o">.</span><span class="n">__version__</span>
    <span class="c1"># Naturally, pip has strictly conformed to PEP440, and does not use</span>
    <span class="c1"># version epochs, since at least v1.2. the oldest I could easily check</span>
    <span class="c1"># (we claim to support &gt;= 1.4.1).</span>
    <span class="c1"># This equates all pre versions with the final one, and that&#39;s good</span>
    <span class="c1"># enough for current purposes:</span>
    <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;rc&#39;</span><span class="p">,</span> <span class="s1">&#39;.dev&#39;</span><span class="p">,</span> <span class="s1">&#39;.post&#39;</span><span class="p">):</span>
        <span class="n">pip_version</span> <span class="o">=</span> <span class="n">pip_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">suffix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pip_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="BaseRecipe"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe">[docs]</a><span class="k">class</span> <span class="nc">BaseRecipe</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for other recipes.</span>

<span class="sd">    It implements notably fetching of the main software part plus addons.</span>

<span class="sd">    The :attr:`sources` attribute is a ``dict`` storing how to fetch the main</span>
<span class="sd">    software part and the specified addons, with the following structure:</span>

<span class="sd">       ``local path -&gt; (type, location_spec, options)``, in which:</span>

<span class="sd">       :local path: is either the :data:`main_software` singleton</span>
<span class="sd">                    (see :class:`MainSoftware`) or a local path to an</span>
<span class="sd">                    addons directory.</span>
<span class="sd">       :type: can be either</span>

<span class="sd">              * ``&#39;local&#39;``</span>
<span class="sd">              * ``&#39;downloadable&#39;``</span>
<span class="sd">              * one of the supported vcs</span>

<span class="sd">       :location_spec: is, depending on the type, a tuple specifying how</span>
<span class="sd">                       fetch is to be done:</span>

<span class="sd">                       ``url``, or ``(vcs_url, vcs_revision)``</span>
<span class="sd">                       or ``None``</span>
<span class="sd">       :addons options: are typically used to specify that the addons</span>
<span class="sd">                        directory is actually a subdir of the specified one.</span>

<span class="sd">                        VCS support classes (see</span>
<span class="sd">                        :mod:`oca.recipe.odoo.vcs`) can implemented their</span>
<span class="sd">                        dedicated options</span>

<span class="sd">    The :attr:`merges` attribute is a ``dict`` storing how to fetch additional</span>
<span class="sd">    changes to merge into VCS type sources:</span>

<span class="sd">       ``local path -&gt; [(type, location_spec, options), ... ]``</span>

<span class="sd">       See :attr:`sources` for the meaning of the various components. Note that</span>
<span class="sd">       in :attr:`merges`, values are a list of triples instead of only a single</span>
<span class="sd">       triple as values in :attr:`sources` because there can be multiple merges</span>
<span class="sd">       on the same local path.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">release_dl_url</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;Base URLs to look for official, released versions.</span>

<span class="sd">    There are currently no official releases for Odoo, but the recipe</span>
<span class="sd">    has been designed at the time of OpenERP 6.0 and some parts of its code</span>
<span class="sd">    at least expect this dict to exist. Besides, official releases may reappear</span>
<span class="sd">    at some point.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nightly_dl_url</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;10.0rc1c&#39;</span><span class="p">:</span> <span class="s1">&#39;http://nightly.odoo.com/10.0/nightly/src/&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;Base URLs to look for nightly versions.</span>

<span class="sd">    The URL for 8.0 may have to be adapted once it&#39;s released for good.</span>
<span class="sd">    This one is guessed from 7.0 and is needed by unit tests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">recipe_requirements</span> <span class="o">=</span> <span class="p">()</span>  <span class="c1"># distribution required for the recipe itself</span>
    <span class="n">recipe_requirements_paths</span> <span class="o">=</span> <span class="p">()</span>  <span class="c1"># a default value is useful in unit tests</span>
    <span class="n">requirements</span> <span class="o">=</span> <span class="p">()</span>  <span class="c1"># requirements for what the recipe installs to run</span>
    <span class="n">soft_requirements</span> <span class="o">=</span> <span class="p">()</span>  <span class="c1"># subset of requirements that&#39;s not necessary</span>
    <span class="n">addons_paths</span> <span class="o">=</span> <span class="p">()</span>

    <span class="c1"># Caching logic for the main Odoo part (e.g, without addons)</span>
    <span class="c1"># Can be &#39;filename&#39; or &#39;http-head&#39;</span>
    <span class="n">main_http_caching</span> <span class="o">=</span> <span class="s1">&#39;filename&#39;</span>

    <span class="n">is_git_layout</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;True if this is the git layout, as seen from the move to GitHub.</span>

<span class="sd">    In this layout, the standard addons other than ``base`` are in a ``addons``</span>
<span class="sd">    directory right next to the ``odoo`` package.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">with_odoo_requirements_file</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Whether attempt to use the &#39;requirements.txt&#39; shipping with Odoo&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BaseRecipe.bool_opt_get"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.bool_opt_get">[docs]</a>    <span class="k">def</span> <span class="nf">bool_opt_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_global</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve an option and interpret it as boolean.</span>

<span class="sd">        Factorized to improve code readability.</span>

<span class="sd">        :param is_global: if ``True``, the option is taken from the</span>
<span class="sd">                          global buildout options instead of the part</span>
<span class="sd">                          taken care of by this recipe instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span> <span class="k">if</span> <span class="n">is_global</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="k">return</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buildout</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requirements</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recipe_requirements_path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">buildout</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="p">[</span><span class="s1">&#39;buildout&#39;</span><span class="p">]</span>
        <span class="c1"># TODO: is adding allow-unknown-extras only necessary for tests?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="p">[</span><span class="s1">&#39;allow-unknown-extras&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;allow-unknown-extras&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildout_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">]</span>
        <span class="c1"># GR: would prefer lower() but doing as in &#39;zc.recipe.egg&#39;</span>
        <span class="c1"># (later) the standard way for all booleans is to use</span>
        <span class="c1"># options.query_bool() or get_bool(), but it doesn&#39;t lower() at all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="p">[</span><span class="s1">&#39;offline&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clean&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
        <span class="n">clear_locks</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vcs-clear-locks&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vcs_clear_locks</span> <span class="o">=</span> <span class="n">clear_locks</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
        <span class="n">clear_retry</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vcs-clear-retry&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_retry</span> <span class="o">=</span> <span class="n">clear_retry</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bool_opt_get</span><span class="p">(</span><span class="n">WITH_ODOO_REQUIREMENTS_FILE_OPTION</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> option: adding &#39;pip&#39; to the recipe requirements&quot;</span><span class="p">,</span>
                         <span class="n">WITH_ODOO_REQUIREMENTS_FILE_OPTION</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">with_odoo_requirements_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recipe_requirements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recipe_requirements</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recipe_requirements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pip&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">python_scripts_executable</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;python-scripts-executable&#39;</span><span class="p">)</span>

        <span class="c1"># same as in zc.recipe.eggs</span>
        <span class="n">relative_paths</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;relative-paths&#39;</span><span class="p">,</span>
            <span class="n">buildout</span><span class="p">[</span><span class="s1">&#39;buildout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relative-paths&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">relative_paths</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_relative_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_relative_paths</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">assert</span> <span class="n">relative_paths</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildout_dir</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">option_splitlines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extra-paths&#39;</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;extra-paths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_paths</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">downloads_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;odoo-downloads-directory&#39;</span><span class="p">,</span> <span class="s1">&#39;downloads&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># from the buildout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_detected</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># string from the odoo setup.py</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="p">[</span><span class="s1">&#39;buildout&#39;</span><span class="p">][</span><span class="s1">&#39;parts-directory&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># downloaded tar.gz</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scripts&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;scripts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># a dictionnary of messages to display in case a distribution is</span>
        <span class="c1"># not installable (kept PIL to have an example, but Odoo is on Pillow)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_deps_instructions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;PIL&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;You don&#39;t need to require it for Odoo any more, since &quot;</span>
                    <span class="s2">&quot;the recipe automatically adds a dependency to Pillow. &quot;</span>
                    <span class="s2">&quot;If you really need it for other reasons, installing it &quot;</span>
                    <span class="s2">&quot;system-wide is a good option. &quot;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">odoo_installed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">etc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;etc-directory&#39;</span><span class="p">,</span> <span class="s1">&#39;etc&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="p">[</span><span class="s1">&#39;buildout&#39;</span><span class="p">][</span><span class="s1">&#39;bin-directory&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.cfg&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloads_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">etc</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created </span><span class="si">%s</span><span class="s1">/ directory&#39;</span> <span class="o">%</span> <span class="n">basename</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merges</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_addons</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_version</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_revisions</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_merges</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="BaseRecipe.parse_version"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.parse_version">[docs]</a>    <span class="k">def</span> <span class="nf">parse_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the main software in :attr:`sources` and related attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span> <span class="o">=</span> <span class="n">option_strip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;You must specify the version&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preinstall_version_check</span><span class="p">()</span>

        <span class="n">version_split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">version_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># version can be a simple version name, such as 6.1-1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">major_wanted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">major_wanted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release_filenames</span><span class="p">[</span><span class="n">major_wanted</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s1">&#39;Odoo version </span><span class="si">%r</span><span class="s1">&#39;</span>
                                <span class="s1">&#39;is not supported&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">archive_filename</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downloads_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_filename</span><span class="p">)</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;base_url&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">release_dl_url</span><span class="p">[</span><span class="n">major_wanted</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">main_software</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;downloadable&#39;</span><span class="p">,</span>
                <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">base_url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_filename</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># in all other cases, the first token is the type of version</span>
        <span class="n">type_spec</span> <span class="o">=</span> <span class="n">version_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">type_spec</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildout_dir</span><span class="p">,</span> <span class="n">version_split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">main_software</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">type_spec</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">version_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">archive_filename</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downloads_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">main_software</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;downloadable&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">type_spec</span> <span class="o">==</span> <span class="s1">&#39;nightly&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">version_split</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span>
                    <span class="s2">&quot;Unrecognized nightly version specification: &quot;</span>
                    <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> (expecting series, number) % version_split[1:]&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nightly_series</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span> <span class="o">=</span> <span class="n">version_split</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">type_spec</span> <span class="o">=</span> <span class="s1">&#39;downloadable&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span> <span class="o">==</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_http_caching</span> <span class="o">=</span> <span class="s1">&#39;http-head&#39;</span>
            <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nightly_series</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">archive_filename</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nightly_filenames</span><span class="p">[</span><span class="n">series</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downloads_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_filename</span><span class="p">)</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_url&#39;</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">nightly_dl_url</span><span class="p">[</span><span class="n">series</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">main_software</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;downloadable&#39;</span><span class="p">,</span>
                <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">base_url</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_filename</span><span class="p">)),</span>
                <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># VCS types</span>
            <span class="n">type_spec</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">repo_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span> <span class="o">=</span> <span class="n">version_split</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">version_split</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">,</span> <span class="n">repo_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">main_software</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">type_spec</span><span class="p">,</span>
                                           <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span><span class="p">),</span> <span class="n">options</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.preinstall_version_check"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.preinstall_version_check">[docs]</a>    <span class="k">def</span> <span class="nf">preinstall_version_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform version checks before any attempt to install.</span>

<span class="sd">        To be subclassed.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="BaseRecipe.install_recipe_requirements"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.install_recipe_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">install_recipe_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Install requirements for the recipe to run.&quot;&quot;&quot;</span>
        <span class="n">to_install</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_requirements</span>
        <span class="n">eggs_option</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_install</span><span class="p">)</span>
        <span class="n">eggs</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">egg</span><span class="o">.</span><span class="n">Eggs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">eggs</span><span class="o">=</span><span class="n">eggs_option</span><span class="p">))</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">eggs</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">eggs</span><span class="o">.</span><span class="n">working_set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recipe_requirements_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">ws</span><span class="o">.</span><span class="n">by_key</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">location</span>
                                          <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">to_install</span><span class="p">]</span>
        <span class="c1"># Some earlier processing leaves tmp dirs behind, that may</span>
        <span class="c1"># mask what we just installed (especially harmful in case of pip)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipe_requirements_paths</span></div>

<div class="viewcode-block" id="BaseRecipe.merge_requirements"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.merge_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">merge_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reqs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge eggs option with self.requirements.</span>


<span class="sd">        TODO refactor all this: merge requirements is not idempotent, it</span>
<span class="sd">        appends. Overall, this going back and forth between the serialized</span>
<span class="sd">        form (self.options[&#39;eggs&#39;]) and the parsed version has growed too</span>
<span class="sd">        much, up to the point where it&#39;s not natural at all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reqs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span>
        <span class="n">serial</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reqs</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;eggs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;eggs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">serial</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;eggs&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">serial</span></div>

<div class="viewcode-block" id="BaseRecipe.list_develops"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.list_develops">[docs]</a>    <span class="k">def</span> <span class="nf">list_develops</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;At any point in time, list the projects that have been developed.</span>

<span class="sd">        This can work as soon as the recipe is instantiated</span>
<span class="sd">        (because the &#39;buildout&#39; part) has already been executed.</span>
<span class="sd">        In particular, it does not rely on the workingset init done by</span>
<span class="sd">        :class:`zc.buildout.easy_install.Installer` and</span>
<span class="sd">        can be used in precedence rules that need to be executed before calling</span>
<span class="sd">        the Installer indirectly via ``zc.recipe.eggs``</span>

<span class="sd">        :return: list of project names</span>

<span class="sd">        Implementation simply lists the develop eggs directory</span>
<span class="sd">        There&#39;s probably better to be done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">devdir_contents</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="p">[</span><span class="s1">&#39;develop-eggs-directory&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">devdir_contents</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;egg-link&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="BaseRecipe.apply_odoo_requirements_file"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.apply_odoo_requirements_file">[docs]</a>    <span class="k">def</span> <span class="nf">apply_odoo_requirements_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try and read Odoo&#39;s &#39;requirements.txt&#39; and apply it.</span>

<span class="sd">        This file appeared in the course of Odoo 8 lifetime. If not available,</span>
<span class="sd">        a warning is issued, that&#39;s all.</span>

<span class="sd">        Entries from the requirements file are applied if there is not already</span>
<span class="sd">        an entry in the versions section for the same project.</span>

<span class="sd">        A more interesting behaviour would be to apply then if they don&#39;t</span>
<span class="sd">        contradict an existing entry in the versions section, but that&#39;s far</span>
<span class="sd">        more complicated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req_fname</span> <span class="o">=</span> <span class="s1">&#39;requirements.txt&#39;</span>
        <span class="n">req_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">,</span> <span class="n">req_fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">req_path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> not found in this version of &quot;</span>
                        <span class="s2">&quot;Odoo, although the configuration said to use it. &quot;</span>
                        <span class="s2">&quot;Proceeding anyway.&quot;</span><span class="p">,</span> <span class="n">req_fname</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># pip wouldn&#39;t be importable before the call to</span>
        <span class="c1"># install_recipe_requirements()</span>

        <span class="c1"># if an extension has used pip before, it can be left in a</span>
        <span class="c1"># strange state where pip.req is not usable nor reloadable</span>
        <span class="c1"># anymore. (may have something to do with the fact that the</span>
        <span class="c1"># first import is done from a tmp dir</span>
        <span class="c1"># that does not exist any more).</span>
        <span class="c1"># So, better to clean that before hand.</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pip&#39;</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="c1"># it is useless to mutate the versions section at this point</span>
        <span class="c1"># it&#39;s already been used to populate the Installer class variable</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="n">Installer</span><span class="o">.</span><span class="n">_versions</span>
        <span class="n">develops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_develops</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pip_version</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_requirements_pip_before_v8</span><span class="p">(</span><span class="n">req_path</span><span class="p">,</span> <span class="n">versions</span><span class="p">,</span> <span class="n">develops</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_requirements_pip_after_v8</span><span class="p">(</span><span class="n">req_path</span><span class="p">,</span> <span class="n">versions</span><span class="p">,</span> <span class="n">develops</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_requirements</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseRecipe.read_requirements_pip_before_v8"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.read_requirements_pip_before_v8">[docs]</a>    <span class="k">def</span> <span class="nf">read_requirements_pip_before_v8</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_path</span><span class="p">,</span> <span class="n">versions</span><span class="p">,</span> <span class="n">develops</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pip.req</span> <span class="kn">import</span> <span class="n">parse_requirements</span>
        <span class="k">if</span> <span class="n">pip_version</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_requirements</span><span class="p">(</span><span class="n">req_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># pip internals are protected against the fact of not passing</span>
            <span class="c1"># a session with ``is None``. OTOH, the session is not used</span>
            <span class="c1"># if the file is local (direct path, not an URL), so we cheat</span>
            <span class="c1"># it.</span>
            <span class="c1"># Although this hack still works with pip 8, it&#39;s considered to be</span>
            <span class="c1"># the kind of thing that can depend on pip version</span>
            <span class="n">fake_session</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_requirements</span><span class="p">(</span><span class="n">req_path</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">fake_session</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">inst_req</span> <span class="ow">in</span> <span class="n">parsed</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">inst_req</span><span class="o">.</span><span class="n">req</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Considering requirement from Odoo&#39;s file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">req</span><span class="p">)</span>
            <span class="c1"># GR something more interesting would be to apply the</span>
            <span class="c1"># requirement if it does not contradict an existing one.</span>
            <span class="c1"># For now that&#39;s too much complicated, but check later if</span>
            <span class="c1"># zc.buildout.easy_install._constrain() fits the bill.</span>

            <span class="n">project_name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">project_name</span>
            <span class="k">if</span> <span class="n">project_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span><span class="p">:</span>
                <span class="c1"># TODO maybe convert self.requirements to a set (in</span>
                <span class="c1"># next unstable branch)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inst_req</span><span class="o">.</span><span class="n">markers</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Requirement </span><span class="si">%s</span><span class="s2"> has a marker </span><span class="si">%s</span><span class="s2"> but the evaluation&quot;</span>
                            <span class="s2">&quot; of markers is not supported in this old version &quot;</span>
                            <span class="s2">&quot;of pip. Please upgrade to pip 8.2 or higher. &quot;</span><span class="p">,</span>
                            <span class="n">project_name</span><span class="p">,</span> <span class="n">inst_req</span><span class="o">.</span><span class="n">markers</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requirement from Odoo&#39;s file </span><span class="si">%s</span><span class="s2"> superseded &quot;</span>
                             <span class="s2">&quot;by buildout versions configuration as </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">req</span><span class="p">,</span> <span class="n">versions</span><span class="p">[</span><span class="n">project_name</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="n">develops</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requirement from Odoo&#39;s file </span><span class="si">%s</span><span class="s2"> superseded &quot;</span>
                             <span class="s2">&quot;by a direct develop directive&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">specs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">supported</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">specs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">supported</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;==&#39;</span> <span class="ow">or</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">supported</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">supported</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span>
                    <span class="s2">&quot;Version requirement </span><span class="si">%s</span><span class="s2"> from Odoo&#39;s requirement file &quot;</span>
                    <span class="s2">&quot;is too complicated to be taken automatically into &quot;</span>
                    <span class="s2">&quot;account. Please override it in your [</span><span class="si">%s</span><span class="s2">] &quot;</span>
                    <span class="s2">&quot;configuration section. Future support of this format &quot;</span>
                    <span class="s2">&quot;is pending the release of buildout 3.0.0 which relies on &quot;</span>
                    <span class="s2">&quot;pip rather than setuptools.easy_install.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">req</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;versions&#39;</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">)))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Applying requirement </span><span class="si">%s</span><span class="s2"> from Odoo&#39;s file&quot;</span><span class="p">,</span>
                         <span class="n">req</span><span class="p">)</span>
            <span class="n">versions</span><span class="p">[</span><span class="n">project_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="BaseRecipe.read_requirements_pip_after_v8"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.read_requirements_pip_after_v8">[docs]</a>    <span class="k">def</span> <span class="nf">read_requirements_pip_after_v8</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_path</span><span class="p">,</span> <span class="n">versions</span><span class="p">,</span> <span class="n">develops</span><span class="p">):</span>
        <span class="c1"># pip internals are protected against the fact of not passing</span>
        <span class="c1"># a session with ``is None``. OTOH, the session is not used</span>
        <span class="c1"># if the file is local (direct path, not an URL), so we cheat</span>
        <span class="c1"># it.</span>
        <span class="n">fake_session</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pip_version</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">pip.req</span> <span class="kn">import</span> <span class="n">parse_requirements</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pip._internal.req</span> <span class="kn">import</span> <span class="n">parse_requirements</span>
        <span class="k">for</span> <span class="n">inst_req</span> <span class="ow">in</span> <span class="n">parse_requirements</span><span class="p">(</span><span class="n">req_path</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">fake_session</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pip_version</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">inst_req</span><span class="o">.</span><span class="n">req</span>
                <span class="n">project_name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="n">inst_req</span><span class="o">.</span><span class="n">markers</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">Requirement</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inst_req</span><span class="o">.</span><span class="n">requirement</span><span class="p">)</span>
                <span class="n">project_name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">project_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">marker</span>
            <span class="k">if</span> <span class="n">marker</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">marker</span><span class="o">.</span><span class="n">evaluate</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping requirement </span><span class="si">%s</span><span class="s2"> with marker </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">project_name</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">specs</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">specifier</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Considering requirement from Odoo&#39;s file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">req</span><span class="p">)</span>
            <span class="c1"># GR something more interesting would be to apply the</span>
            <span class="c1"># requirement if it does not contradict an existing one.</span>
            <span class="c1"># For now that&#39;s too much complicated, but check later if</span>
            <span class="c1"># zc.buildout.easy_install._constrain() fits the bill.</span>

            <span class="c1"># zc.buildout does its version comparison in lower case</span>
            <span class="c1"># watch out for develops if that&#39;s the same !</span>
            <span class="k">if</span> <span class="n">project_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span><span class="p">:</span>
                <span class="c1"># TODO maybe convert self.requirements to a set (in</span>
                <span class="c1"># next unstable branch)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requirement from Odoo&#39;s file </span><span class="si">%s</span><span class="s2"> superseded &quot;</span>
                             <span class="s2">&quot;by buildout versions configuration as </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">req</span><span class="p">,</span> <span class="n">versions</span><span class="p">[</span><span class="n">project_name</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="n">develops</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requirement from Odoo&#39;s file </span><span class="si">%s</span><span class="s2"> superseded &quot;</span>
                             <span class="s2">&quot;by a direct develop directive&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">specs</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">specifier</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">specs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">supported</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">supported</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">specs</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">operator</span> <span class="o">!=</span> <span class="s1">&#39;==&#39;</span> <span class="ow">or</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
                <span class="n">supported</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">supported</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span>
                    <span class="s2">&quot;Version requirement </span><span class="si">%s</span><span class="s2"> from Odoo&#39;s requirement file &quot;</span>
                    <span class="s2">&quot;is too complicated to be taken automatically into &quot;</span>
                    <span class="s2">&quot;account. Please override it in your [</span><span class="si">%s</span><span class="s2">] &quot;</span>
                    <span class="s2">&quot;configuration section. Future support of this format &quot;</span>
                    <span class="s2">&quot;is pending the release of buildout 3.0.0 which relies on &quot;</span>
                    <span class="s2">&quot;pip rather than setuptools.easy_install.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">req</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;versions&#39;</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">)))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Applying requirement </span><span class="si">%s</span><span class="s2"> from Odoo&#39;s file&quot;</span><span class="p">,</span>
                         <span class="n">req</span><span class="p">)</span>
            <span class="n">versions</span><span class="p">[</span><span class="n">project_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">version</span></div>

<div class="viewcode-block" id="BaseRecipe.install_requirements"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.install_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">install_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Install egg requirements and scripts.</span>

<span class="sd">        If some distributions are known as soft requirements, will retry</span>
<span class="sd">        without them</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_odoo_requirements_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_odoo_requirements_file</span><span class="p">()</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">eggs_recipe</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">recipe</span><span class="o">.</span><span class="n">egg</span><span class="o">.</span><span class="n">Scripts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
            <span class="n">raised_exc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">eggs_recipe</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">MissingDistribution</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">raised_exc</span> <span class="o">=</span> <span class="n">exc</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">project_name</span>
            <span class="k">except</span> <span class="n">VersionConflict</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="c1"># GR not 100% sure, but this should mean a conflict with an</span>
                <span class="c1"># already loaded version (don&#39;t know what can lead to this</span>
                <span class="c1"># &#39;already&#39;, have seen it with zc.buildout itself only so far)</span>
                <span class="c1"># In any case, removing the requirement can&#39;t make for a sane</span>
                <span class="c1"># recovery</span>
                <span class="n">raised_exc</span> <span class="o">=</span> <span class="n">exc</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="n">IncompatibleConstraintError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">raised_exc</span> <span class="o">=</span> <span class="n">exc</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">project_name</span>
            <span class="k">except</span> <span class="n">UserError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># happens only for zc.buildout &gt;= 2.0</span>
                <span class="n">raised_exc</span> <span class="o">=</span> <span class="n">exc</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[=&lt;&gt;]&#39;</span><span class="p">,</span> <span class="n">missing</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find or install </span><span class="si">%r</span><span class="s2">. &quot;</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">missing_deps_instructions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">missing</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                         <span class="s2">&quot; Original exception </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> says: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">missing</span><span class="p">,</span> <span class="n">raised_exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                         <span class="n">raised_exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">raised_exc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">missing</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">soft_requirements</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">raised_exc</span>

            <span class="n">eggs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;eggs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">missing</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eggs</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Soft requirement </span><span class="si">%r</span><span class="s2"> is also an indirect &quot;</span>
                             <span class="s2">&quot;dependency (either of OpenERP/Odoo or of &quot;</span>
                             <span class="s2">&quot;one listed in config file). Can&#39;t retry.&quot;</span><span class="p">,</span>
                             <span class="n">missing</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">raised_exc</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is a direct soft requirement, &quot;</span>
                        <span class="s2">&quot;retrying without it&quot;</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>
            <span class="n">eggs</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;eggs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">eggs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eggs_reqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eggs_ws</span> <span class="o">=</span> <span class="n">eggs_recipe</span><span class="o">.</span><span class="n">working_set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eggs_ws</span></div>

<div class="viewcode-block" id="BaseRecipe.apply_version_dependent_decisions"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.apply_version_dependent_decisions">[docs]</a>    <span class="k">def</span> <span class="nf">apply_version_dependent_decisions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store some booleans depending on detected version.</span>

<span class="sd">        To be refined by subclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">major_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">detected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_detected</span>
        <span class="k">if</span> <span class="n">detected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">major_version</span><span class="p">(</span><span class="n">detected</span><span class="p">)</span>

<div class="viewcode-block" id="BaseRecipe.read_release"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.read_release">[docs]</a>    <span class="k">def</span> <span class="nf">read_release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try and read the release.py file directly.</span>

<span class="sd">        Used as a fallback in case reading setup.py failed, which happened</span>
<span class="sd">        in an old OpenERP version. Could become the norm, but setup is also</span>
<span class="sd">        used to list dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="s1">&#39;release.py&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="s1">&#39;release&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;release.py&#39;</span><span class="p">,</span>
                                  <span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">imp</span><span class="o">.</span><span class="n">PY_SOURCE</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_detected</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">version</span></div>

<div class="viewcode-block" id="BaseRecipe.read_odoo_setup"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.read_odoo_setup">[docs]</a>    <span class="k">def</span> <span class="nf">read_odoo_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ugly method to extract requirements &amp; version from ugly setup.py.</span>

<span class="sd">        Primarily designed for 6.0, but works with 6.1 as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_setup</span> <span class="o">=</span> <span class="n">setuptools</span><span class="o">.</span><span class="n">setup</span>
        <span class="n">old_distutils_setup</span> <span class="o">=</span> <span class="n">distutils</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">setup</span>  <span class="c1"># 5.0 directly imports this</span>

        <span class="k">def</span> <span class="nf">new_setup</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;install_requires&#39;</span><span class="p">,</span> <span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_detected</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="n">setuptools</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">new_setup</span>
        <span class="n">distutils</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">new_setup</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">,</span> <span class="s1">&#39;setup.py&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">saved_argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;setup.py&#39;</span><span class="p">,</span> <span class="s1">&#39;develop&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;setup.py&#39;</span><span class="p">,</span>
                                <span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">imp</span><span class="o">.</span><span class="n">PY_SOURCE</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;dsextras&#39;</span> <span class="ow">in</span> <span class="n">unicode</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span>
                        <span class="s1">&#39;Please first install PyGObject and PyGTK !&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">read_release</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span>
                            <span class="s1">&#39;Problem while reading Odoo release.py: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;babel&#39;</span> <span class="ow">in</span> <span class="n">unicode</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span>
                        <span class="s1">&#39;OpenERP setup.py has an unwanted import Babel.</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;=&gt; First install Babel on your system or &#39;</span>
                        <span class="s1">&#39;virtualenv :(</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;(sudo aptitude install python-babel, &#39;</span>
                        <span class="s1">&#39;or pip install babel)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exception</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s1">&#39;Problem while reading Odoo &#39;</span>
                                       <span class="s1">&#39;setup.py: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exception</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">saved_argv</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">setuptools</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">old_setup</span>
        <span class="n">distutils</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">old_distutils_setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_version_dependent_decisions</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseRecipe.make_absolute"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.make_absolute">[docs]</a>    <span class="k">def</span> <span class="nf">make_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a path absolute if needed.</span>

<span class="sd">        If not already absolute, it is interpreted as relative to the</span>
<span class="sd">        buildout directory.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildout_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.sandboxed_tar_extract"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.sandboxed_tar_extract">[docs]</a>    <span class="k">def</span> <span class="nf">sandboxed_tar_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">,</span> <span class="n">tarfile</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract those members that are below the tarfile path &#39;sandbox&#39;.</span>

<span class="sd">        The tarfile module official doc warns against attacks with .. in tar.</span>

<span class="sd">        The option to start with a first member is useful for this case, since</span>
<span class="sd">        the recipe consumes a first member in the tar file to get the odoo</span>
<span class="sd">        main directory in parts.</span>
<span class="sd">        It is taken for granted that this first member has already been</span>
<span class="sd">        checked.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tarfile</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tinfo</span> <span class="ow">in</span> <span class="n">tarfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tinfo</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sandbox</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="n">tarfile</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">tinfo</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Tarball member </span><span class="si">%r</span><span class="s1"> is outside of </span><span class="si">%r</span><span class="s1">. Ignored.&#39;</span><span class="p">,</span>
                            <span class="n">tinfo</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.develop"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.develop">[docs]</a>    <span class="k">def</span> <span class="nf">develop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Develop the specified source distribution.</span>

<span class="sd">        Any call to ``zc.recipe.eggs`` will use that developped version.</span>
<span class="sd">        :meth:`develop` launches a subprocess, to which we need to forward</span>
<span class="sd">        the paths to requirements via PYTHONPATH.</span>

<span class="sd">        :param setup_has_pil: if ``True``, an altered version of setup that</span>
<span class="sd">                              does not require PIL is produced to perform the</span>
<span class="sd">                              develop, so that installation can be done with</span>
<span class="sd">                              ``Pillow`` instead. Recent enough versions of</span>
<span class="sd">                              OpenERP/Odoo are directly based on Pillow.</span>
<span class="sd">        :returns: project name of the distribution that&#39;s been &quot;developed&quot;</span>
<span class="sd">                  This is useful for OpenERP/Odoo itself, whose project name</span>
<span class="sd">                  changed within the 8.0 stable branch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Developing </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">src_directory</span><span class="p">)</span>
        <span class="n">develop_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="p">[</span><span class="s1">&#39;develop-eggs-directory&#39;</span><span class="p">]</span>
        <span class="n">pythonpath_bak</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">putenv</span><span class="p">(</span><span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recipe_requirements_paths</span><span class="p">))</span>

        <span class="n">egg_link</span> <span class="o">=</span> <span class="n">zc</span><span class="o">.</span><span class="n">buildout</span><span class="o">.</span><span class="n">easy_install</span><span class="o">.</span><span class="n">develop</span><span class="p">(</span><span class="n">src_directory</span><span class="p">,</span> <span class="n">develop_dir</span><span class="p">)</span>

        <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;.egg-link&#39;</span>

        <span class="k">if</span> <span class="n">pythonpath_bak</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unsetenv</span><span class="p">(</span><span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">putenv</span><span class="p">(</span><span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">,</span> <span class="n">pythonpath_bak</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">egg_link</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Development of OpenERP/Odoo distribution &quot;</span>
                <span class="s2">&quot;produced an unexpected egg link: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">egg_link</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">egg_link</span><span class="p">)[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span></div>

<div class="viewcode-block" id="BaseRecipe.parse_addons"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.parse_addons">[docs]</a>    <span class="k">def</span> <span class="nf">parse_addons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the addons options into :attr:`sources`.</span>

<span class="sd">        See :class:`BaseRecipe` for the structure of :attr:`sources`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">option_splitlines</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;addons&#39;</span><span class="p">)):</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">split</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">loc_type</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">spec_len</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">loc_type</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span> <span class="k">else</span> <span class="mi">4</span>

                <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">split</span><span class="p">[</span><span class="n">spec_len</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">loc_type</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                    <span class="n">addons_dir</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">location_spec</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># vcs</span>
                    <span class="n">repo_url</span><span class="p">,</span> <span class="n">addons_dir</span><span class="p">,</span> <span class="n">repo_rev</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">location_spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">repo_url</span><span class="p">,</span> <span class="n">repo_rev</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;Could not parse addons line: </span><span class="si">%r</span><span class="s2">. &quot;</span>
                                <span class="s2">&quot;Please check format &quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>

            <span class="n">addons_dir</span> <span class="o">=</span> <span class="n">addons_dir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># trailing / can be harmful</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">addons_dir</span><span class="p">)</span>
                <span class="n">addons_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">group</span><span class="p">,</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">addons_dir</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">loc_type</span><span class="p">,</span> <span class="n">location_spec</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.parse_merges"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.parse_merges">[docs]</a>    <span class="k">def</span> <span class="nf">parse_merges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the merge options into :attr:`merges`.</span>

<span class="sd">        See :class:`BaseRecipe` for the structure of :attr:`merges`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">option_splitlines</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;merges&#39;</span><span class="p">)):</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">split</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">loc_type</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">loc_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;bzr&#39;</span><span class="p">,</span> <span class="s1">&#39;git&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;Only merges of type &#39;bzr&#39; and &#39;git&#39; are &quot;</span>
                                <span class="s2">&quot;currently supported.&quot;</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">split</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">loc_type</span> <span class="o">==</span> <span class="s1">&#39;bzr&#39;</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;bzr-init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;merge&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;merge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">repo_url</span><span class="p">,</span> <span class="n">local_dir</span><span class="p">,</span> <span class="n">repo_rev</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">location_spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">repo_url</span><span class="p">,</span> <span class="n">repo_rev</span><span class="p">)</span>

            <span class="n">local_dir</span> <span class="o">=</span> <span class="n">local_dir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># trailing / can be harmful</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merges</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">local_dir</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">loc_type</span><span class="p">,</span> <span class="n">location_spec</span><span class="p">,</span> <span class="n">options</span><span class="p">))</span></div>

<div class="viewcode-block" id="BaseRecipe.parse_revisions"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.parse_revisions">[docs]</a>    <span class="k">def</span> <span class="nf">parse_revisions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse revisions options and update :attr:`sources`.</span>

<span class="sd">        It is assumed that :attr:`sources` has already been populated, and</span>
<span class="sd">        notably has a :data:`main_software` entry.</span>
<span class="sd">        This allows for easy fixing of revisions in an extension buildout</span>

<span class="sd">        See :class:`BaseRecipe` for the structure of :attr:`sources`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">option_splitlines</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;revisions&#39;</span><span class="p">)):</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;Invalid revisions line: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>

            <span class="c1"># addon or main software</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_path</span> <span class="o">=</span> <span class="n">main_software</span>
            <span class="n">revision</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># considered harmless for now</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Ignoring attempt to fix revision on unknown &quot;</span>
                            <span class="s2">&quot;source </span><span class="si">%r</span><span class="s2">. You may have a leftover to clean&quot;</span><span class="p">,</span>
                            <span class="n">local_path</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;downloadable&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;In revision line </span><span class="si">%r</span><span class="s2"> : can&#39;t fix a revision &quot;</span>
                                <span class="s2">&quot;for non-vcs source&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> will be on revision </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">revision</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">local_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">revision</span><span class="p">))</span> <span class="o">+</span> <span class="n">source</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.retrieve_addons"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.retrieve_addons">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_addons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Peform all lookup and downloads specified in :attr:`sources`.</span>

<span class="sd">        See :class:`BaseRecipe` for the structure of :attr:`sources`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addons_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">local_dir</span><span class="p">,</span> <span class="n">source_spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">local_dir</span> <span class="ow">is</span> <span class="n">main_software</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">loc_type</span><span class="p">,</span> <span class="n">loc_spec</span><span class="p">,</span> <span class="n">addons_options</span> <span class="o">=</span> <span class="n">source_spec</span>
            <span class="n">local_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">offline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offline</span><span class="p">,</span>
                           <span class="n">clear_locks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vcs_clear_locks</span><span class="p">,</span>
                           <span class="n">clean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loc_type</span> <span class="o">==</span> <span class="s1">&#39;git&#39;</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;git-depth&#39;</span><span class="p">)</span>
            <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">addons_options</span><span class="p">)</span>

            <span class="n">group</span> <span class="o">=</span> <span class="n">addons_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
            <span class="n">group_dir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loc_type</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span>
                        <span class="s2">&quot;Automatic grouping of addons is not supported for &quot;</span>
                        <span class="s2">&quot;local addons such as </span><span class="si">%r</span><span class="s2">, because the recipe &quot;</span>
                        <span class="s2">&quot;considers that write operations in a local &quot;</span>
                        <span class="s2">&quot;directory is &quot;</span>
                        <span class="s2">&quot;outside of its reponsibilities (in other words, &quot;</span>
                        <span class="s2">&quot;it&#39;s better if &quot;</span>
                        <span class="s2">&quot;you create yourself the intermediate directory.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">local_dir</span><span class="p">,</span> <span class="p">))</span>

                <span class="n">group_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">group_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">group_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loc_type</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">loc_type</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                        <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

                <span class="n">repo_url</span><span class="p">,</span> <span class="n">repo_rev</span> <span class="o">=</span> <span class="n">loc_spec</span>
                <span class="n">vcs</span><span class="o">.</span><span class="n">get_update</span><span class="p">(</span><span class="n">loc_type</span><span class="p">,</span> <span class="n">local_dir</span><span class="p">,</span> <span class="n">repo_url</span><span class="p">,</span> <span class="n">repo_rev</span><span class="p">,</span>
                               <span class="n">clear_retry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_retry</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">options</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">clean_object_files</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>

            <span class="n">subdir</span> <span class="o">=</span> <span class="n">addons_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subdir&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group_dir</span><span class="p">:</span>
                <span class="n">addons_dir</span> <span class="o">=</span> <span class="n">group_dir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">addons_dir</span> <span class="o">=</span> <span class="n">local_dir</span>

            <span class="k">if</span> <span class="n">subdir</span><span class="p">:</span>
                <span class="n">addons_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">addons_dir</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span>

            <span class="n">manifest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">addons_dir</span><span class="p">,</span> <span class="s1">&#39;__manifest__.py&#39;</span><span class="p">)</span>
            <span class="n">manifest_pre_v10</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">addons_dir</span><span class="p">,</span> <span class="s1">&#39;__openerp__.py&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">manifest</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">manifest_pre_v10</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;Standalone addons such as </span><span class="si">%r</span><span class="s2"> &quot;</span>
                                <span class="s2">&quot;are now supported by means &quot;</span>
                                <span class="s2">&quot;of the explicit &#39;group&#39; option. Please &quot;</span>
                                <span class="s2">&quot;update your buildout configuration. &quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">addons_dir</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">addons_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">addons_paths</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addons_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">addons_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.revert_sources"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.revert_sources">[docs]</a>    <span class="k">def</span> <span class="nf">revert_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Revert all sources to the revisions specified in :attr:`sources`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;downloadable&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">vcs_type</span><span class="p">,</span> <span class="n">vcs_spec</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">desc</span>
            <span class="n">local_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span> <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="n">main_software</span> <span class="k">else</span> <span class="n">target</span>
            <span class="n">local_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">.</span><span class="n">repo</span><span class="p">(</span><span class="n">vcs_type</span><span class="p">,</span> <span class="n">local_dir</span><span class="p">,</span> <span class="n">vcs_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repo</span><span class="o">.</span><span class="n">revert</span><span class="p">(</span><span class="n">vcs_spec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;vcs-revert: not implemented for </span><span class="si">%s</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;repository at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vcs_type</span><span class="p">,</span> <span class="n">local_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reverted </span><span class="si">%s</span><span class="s2"> repository at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">vcs_type</span><span class="p">,</span> <span class="n">local_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.retrieve_merges"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.retrieve_merges">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_merges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Peform all VCS merges specified in :attr:`merges`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vcs-revert&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;on-merge&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reverting all sources before merge&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">revert_sources</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">local_dir</span><span class="p">,</span> <span class="n">source_specs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">merges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">source_spec</span> <span class="ow">in</span> <span class="n">source_specs</span><span class="p">:</span>
                <span class="n">loc_type</span><span class="p">,</span> <span class="n">loc_spec</span><span class="p">,</span> <span class="n">merge_options</span> <span class="o">=</span> <span class="n">source_spec</span>
                <span class="n">local_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>
                <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">offline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offline</span><span class="p">,</span>
                               <span class="n">clear_locks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vcs_clear_locks</span><span class="p">)</span>
                <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">merge_options</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">loc_type</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                        <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

                <span class="n">repo_url</span><span class="p">,</span> <span class="n">repo_rev</span> <span class="o">=</span> <span class="n">loc_spec</span>
                <span class="n">vcs</span><span class="o">.</span><span class="n">get_update</span><span class="p">(</span><span class="n">loc_type</span><span class="p">,</span> <span class="n">local_dir</span><span class="p">,</span> <span class="n">repo_url</span><span class="p">,</span> <span class="n">repo_rev</span><span class="p">,</span>
                               <span class="n">clear_retry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_retry</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">options</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.main_download"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.main_download">[docs]</a>    <span class="k">def</span> <span class="nf">main_download</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;HTTP download for main part of the software to self.archive_path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offline</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found, and offline &quot;</span>
                          <span class="s2">&quot;mode requested&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">main_software</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Downloading </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">get_content_type</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;text/html&#39;</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
                    <span class="s1">&#39;Wanted version </span><span class="si">%r</span><span class="s1"> not found on server (tried </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">tarfile</span><span class="o">.</span><span class="n">TarError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
            <span class="c1"># GR: ContentTooShortError subclasses IOError</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;The archive does not seem valid: &#39;</span> <span class="o">+</span>
                          <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">))</span></div>

<div class="viewcode-block" id="BaseRecipe.is_stale_http_head"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.is_stale_http_head">[docs]</a>    <span class="k">def</span> <span class="nf">is_stale_http_head</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tell if the download is stale by doing a HEAD request.</span>

<span class="sd">        Assumes the correct date had been written upon download.</span>
<span class="sd">        This is the same system as in GNU Wget 1.12. It works even if</span>
<span class="sd">        the server does not implement conditional responses such as 304</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">archivestat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span>
        <span class="n">length</span><span class="p">,</span> <span class="n">modified</span> <span class="o">=</span> <span class="n">archivestat</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">archivestat</span><span class="o">.</span><span class="n">st_mtime</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">main_software</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if </span><span class="si">%s</span><span class="s2"> if fresh wrt </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;https&#39;</span><span class="p">:</span>
            <span class="n">cnx_cls</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPSConnection</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cnx_cls</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cnx</span> <span class="o">=</span> <span class="n">cnx_cls</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">)</span>
            <span class="n">cnx</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># TODO query ? fragment ?</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">head_modified</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s1">&#39;Last-Modified&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Last-modified from HEAD request: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">head_modified</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rfc822_time</span><span class="p">(</span><span class="n">head_modified</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">modified</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No need to re-download </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.retrieve_main_software"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.retrieve_main_software">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_main_software</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lookup or fetch the main software.</span>

<span class="sd">        See :class:`MainSoftware` and :class:`BaseRecipe` for explanations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">main_software</span><span class="p">]</span>
        <span class="n">type_spec</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Selected install type: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">type_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">type_spec</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Local directory chosen, nothing to do&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">clean_object_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">type_spec</span> <span class="o">==</span> <span class="s1">&#39;downloadable&#39;</span><span class="p">:</span>
            <span class="c1"># download if needed</span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span> <span class="ow">and</span>
                 <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">))</span> <span class="ow">or</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_http_caching</span> <span class="o">==</span> <span class="s1">&#39;http-head&#39;</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">is_stale_http_head</span><span class="p">())):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_download</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Inspecting </span><span class="si">%s</span><span class="s1"> ...&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span>
            <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">tar</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Everything that follows assumes all tarball members</span>
            <span class="c1"># are inside a directory with an expected name such</span>
            <span class="c1"># as odoo-6.1-1</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">isdir</span><span class="p">())</span>
            <span class="n">extracted_name</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">,</span> <span class="n">extracted_name</span><span class="p">)</span>
            <span class="c1"># protection against malicious tarballs</span>
            <span class="k">assert</span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">extracted_name</span><span class="p">))</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning existing </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Extracting </span><span class="si">%s</span><span class="s1"> ...&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sandboxed_tar_extract</span><span class="p">(</span><span class="n">extracted_name</span><span class="p">,</span> <span class="n">tar</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="n">first</span><span class="p">)</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                           <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">type_spec</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">type_spec</span> <span class="o">==</span> <span class="s1">&#39;git&#39;</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;git-depth&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;clean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">vcs</span><span class="o">.</span><span class="n">get_update</span><span class="p">(</span><span class="n">type_spec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span>
                           <span class="n">offline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offline</span><span class="p">,</span>
                           <span class="n">clear_retry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_retry</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_register_extra_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add odoo paths into the extra-paths (used in scripts&#39; sys.path).</span>

<span class="sd">        This is useful up to the 6.0 series only, because in later version,</span>
<span class="sd">        the &#39;odoo&#39; directory is a proper distribution that we develop, with</span>
<span class="sd">        the effect of putting it on the path automatically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;extra-paths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>

<div class="viewcode-block" id="BaseRecipe.install"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.install">[docs]</a>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span>

        <span class="n">freeze_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;freeze-to&#39;</span><span class="p">)</span>
        <span class="n">extract_downloads_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extract-downloads-to&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">freeze_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">extract_downloads_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">offline</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;To freeze a part, you must run offline &quot;</span>
                            <span class="s2">&quot;so that there&#39;s no modification from what &quot;</span>
                            <span class="s2">&quot;you just tested. Please rerun with -o.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">extract_downloads_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">freeze_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freeze_to</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_downloads_to</span><span class="p">,</span>
                                     <span class="s1">&#39;extracted_from.cfg&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">retrieve_main_software</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrieve_addons</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrieve_merges</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">install_recipe_requirements</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">)</span>  <span class="c1"># GR probably not needed any more</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_odoo_setup</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">main_software</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;downloadable&#39;</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span> <span class="o">==</span> <span class="s1">&#39;latest&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nightly_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_detected</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Detected &#39;nightly latest version&#39;, you may want to &quot;</span>
                        <span class="s2">&quot;fix it in your config file for replayability: </span><span class="se">\n</span><span class="s2">    &quot;</span>
                        <span class="s2">&quot;version = &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_nightly_latest_version</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finalize_addons_paths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_extra_paths</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_detected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s1">&#39;Version of Odoo could not be detected&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_requirements</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_requirements</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_install_startup_scripts</span><span class="p">()</span>

        <span class="c1"># create the config file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating config file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout_dir</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_config</span><span class="p">()</span>

        <span class="c1"># modify the config file according to recipe options</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">RawConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">recipe_option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">recipe_option</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="n">recipe_option</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">conf_ensure_section</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">recipe_option</span><span class="p">])</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">extract_downloads_to</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extract_downloads_to</span><span class="p">(</span><span class="n">extract_downloads_to</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">freeze_to</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freeze_to</span><span class="p">(</span><span class="n">freeze_to</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">odoo_installed</span></div>

<div class="viewcode-block" id="BaseRecipe.dump_nightly_latest_version"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.dump_nightly_latest_version">[docs]</a>    <span class="k">def</span> <span class="nf">dump_nightly_latest_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;After download/analysis of &#39;nightly latest&#39;, give equivalent spec.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;nightly&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nightly_series</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nightly_version</span><span class="p">))</span></div>

<div class="viewcode-block" id="BaseRecipe.freeze_to"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.freeze_to">[docs]</a>    <span class="k">def</span> <span class="nf">freeze_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_config_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an extension buildout freezing current revisions &amp; versions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Freezing part </span><span class="si">%r</span><span class="s2"> to config file </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">out_config_path</span><span class="p">)</span>
        <span class="n">out_conf</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>

        <span class="n">frozen</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="p">,</span> <span class="s1">&#39;_odoo_recipe_frozen&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frozen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frozen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="o">.</span><span class="n">_odoo_recipe_frozen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">out_config_path</span> <span class="ow">in</span> <span class="n">frozen</span><span class="p">:</span>
            <span class="c1"># read configuration started by other recipe</span>
            <span class="n">out_conf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">out_config_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_frozen_buildout</span><span class="p">(</span><span class="n">out_conf</span><span class="p">)</span>

        <span class="c1"># The name the versions section is hardcoded, but that&#39;s tolerable</span>
        <span class="c1"># because that&#39;s actually the one we *produce*</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_egg_versions</span><span class="p">(</span><span class="n">out_conf</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">)</span>

        <span class="n">conf_ensure_section</span><span class="p">(</span><span class="n">out_conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">addons_option</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_modifications</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">source_type</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">local_path</span> <span class="ow">is</span> <span class="n">main_software</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s1">&#39;downloadable&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_downloadable_main_software</span><span class="p">(</span><span class="n">out_conf</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># vcs</span>
                    <span class="n">abspath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_odoo_dir</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">abspath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s1">&#39;downloadable&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">required_rev</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">revision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_vcs_source</span><span class="p">(</span>
                <span class="n">source_type</span><span class="p">,</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">required_rev</span><span class="p">)</span>

            <span class="c1"># here it would be tempting not to repeat the freeze if</span>
            <span class="c1"># the resulting revision is equal to revision_rev, BUT</span>
            <span class="c1"># if revision_rev itself comes from use of the &#39;revisons&#39; option</span>
            <span class="c1"># then we could have masking of that in the extended buildout</span>
            <span class="c1"># this could be taken care of for aesthetics by careful use of</span>
            <span class="c1"># += and actually specification of what it should do for</span>
            <span class="c1"># the &#39;revisions&#39; option. In the meanwhile, let&#39;s just play safe</span>

            <span class="k">if</span> <span class="n">local_path</span> <span class="ow">is</span> <span class="n">main_software</span><span class="p">:</span>
                <span class="n">addons_option</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">  ; main software part&#39;</span> <span class="o">%</span> <span class="n">revision</span><span class="p">)</span>
                <span class="c1"># actually, that comment will be lost if this is not the</span>
                <span class="c1"># last part (dropped upon reread)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">addons_option</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">local_path</span><span class="p">,</span> <span class="n">revision</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">addons_option</span><span class="p">:</span>
            <span class="n">out_conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;revisions&#39;</span><span class="p">,</span>
                         <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">addons_option</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_modifications</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Uncommitted changes and/or untracked files in: </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Unsafe to freeze. Please commit or revert and test again !&quot;</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;   - &#39;</span> <span class="o">+</span> <span class="n">p</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_modifications</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]))</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>  <span class="c1"># GR I like that number</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">out_config_path</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out_conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">frozen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">out_config_path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_gp_vcs_develops</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a tuple of (raw, parsed, sub_dir, abs_path)</span>
<span class="sd">        vcs-extends-develop specifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sub_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">GP_DEVELOP_DIR</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">GP_VCS_EXTEND_DEVELOP</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pip._internal.req</span> <span class="kn">import</span> <span class="n">constructors</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You have vcs-extends-develop distributions &quot;</span>
                         <span class="s2">&quot;but pip is not available. That means that &quot;</span>
                         <span class="s2">&quot;gp.vcsdevelop is not properly installed. Did &quot;</span>
                         <span class="s2">&quot;you ever run that buildout ?&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">def</span> <span class="nf">parse_egg_dir</span><span class="p">(</span><span class="n">req_str</span><span class="p">):</span>
            <span class="n">ireq</span> <span class="o">=</span> <span class="n">constructors</span><span class="o">.</span><span class="n">install_req_from_editable</span><span class="p">(</span><span class="n">req_str</span><span class="p">)</span>
            <span class="c1"># GR I&#39;m worried because now this is also used as project</span>
            <span class="c1"># name in requirement, whereas it used to just be the target</span>
            <span class="c1"># directory</span>
            <span class="k">return</span> <span class="n">ireq</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># pip &gt;= 8.1.2</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">option_splitlines</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">parse_egg_dir</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
            <span class="n">abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">raw</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">,</span> <span class="n">abs_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_frozen_buildout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the &#39;buildout&#39; section in conf.&quot;&quot;&quot;</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;buildout&#39;</span><span class="p">)</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;buildout&#39;</span><span class="p">,</span> <span class="s1">&#39;extends&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout_cfg_name</span><span class="p">())</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;versions&#39;</span><span class="p">)</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;buildout&#39;</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">)</span>

        <span class="c1"># freezing for gp.vcsdevelop</span>
        <span class="n">extends</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">raw</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">abs_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gp_vcs_develops</span><span class="p">():</span>
            <span class="n">hash_split</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">hash_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rev_split</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">rev_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">revspec</span> <span class="o">=</span> <span class="n">rev_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">vcs_type</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># vcs-develop process adds .egg-info file (often forgotten in VCS</span>
            <span class="c1"># ignore files) and changes setup.cfg.</span>
            <span class="c1"># For now we&#39;ll have to allow local modifications.</span>
            <span class="n">revision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_vcs_source</span><span class="p">(</span><span class="n">vcs_type</span><span class="p">,</span>
                                               <span class="n">abs_path</span><span class="p">,</span>
                                               <span class="n">revspec</span><span class="p">,</span>
                                               <span class="n">pip_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">allow_local_modification</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">extends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">@</span><span class="si">%s</span><span class="s1">#</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">hash_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;buildout&#39;</span><span class="p">,</span> <span class="n">GP_VCS_EXTEND_DEVELOP</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extends</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_freeze_downloadable_main_software</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If needed, sets the main version option in ConfigParser.</span>

<span class="sd">        Currently does not dump the fully resolved URL, since future</span>
<span class="sd">        reproduction may be better done with another URL base holding archived</span>
<span class="sd">        old versions : it&#39;s better to let tomorrow logic handle that</span>
<span class="sd">        from higher level information.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_wanted</span> <span class="o">==</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump_nightly_latest_version</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_freeze_egg_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Update a ConfigParser section with current working set egg versions.</span>

<span class="sd">        This also forces not to use the requirements file from Odoo, hence</span>
<span class="sd">        avoiding a deploy-time dependency on pip for something that is not</span>
<span class="sd">        needed and could only be a source of issues.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conf_ensure_section</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">WITH_ODOO_REQUIREMENTS_FILE_OPTION</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="n">versions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="n">versions</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">egg</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">egg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">by_key</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span> <span class="ow">and</span>
                        <span class="n">egg</span><span class="o">.</span><span class="n">precedence</span> <span class="o">!=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">DEVELOP_DIST</span>
                        <span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">versions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>

        <span class="c1"># forbidding picked versions if this zc.buildout supports it right away</span>
        <span class="c1"># i.e. we are on zc.buildout &gt;= 2.0</span>
        <span class="n">allow_picked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;freeze-allow-picked-versions&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allow_picked</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
            <span class="n">pick_opt</span> <span class="o">=</span> <span class="s1">&#39;allow-picked-versions&#39;</span>
            <span class="k">if</span> <span class="n">pick_opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="p">:</span>
                <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;buildout&#39;</span><span class="p">,</span> <span class="n">pick_opt</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_freeze_vcs_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vcs_type</span><span class="p">,</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">revspec</span><span class="p">,</span>
                           <span class="n">pip_compatible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">allow_local_modification</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the frozen revision for the state of that VCS source.</span>

<span class="sd">        :param vcs_type: self-explanatory</span>
<span class="sd">        :param abspath: absolute path to local repository</span>
<span class="sd">        :param revspec: the revision specification as required in the buildout</span>
<span class="sd">                        configuration (can be suitable in itself and better</span>
<span class="sd">                        than what we can produce)</span>
<span class="sd">        :param pip_compatible: if ``True``, a pip compatible revision number</span>
<span class="sd">                               is issued. This depends on the precise vcs.</span>
<span class="sd">        :returns: ``None`` if ``revspec`` is already a frozen and reproducible</span>
<span class="sd">                  specification.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">repo</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">.</span><span class="n">repo</span><span class="p">(</span><span class="n">vcs_type</span><span class="p">,</span> <span class="n">abspath</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># no need of remote URL</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_local_modification</span> <span class="ow">and</span> <span class="n">repo</span><span class="o">.</span><span class="n">uncommitted_changes</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">revspec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">repo</span><span class="o">.</span><span class="n">is_local_fixed_revision</span><span class="p">(</span><span class="n">revspec</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">revspec</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">parents</span><span class="p">(</span><span class="n">pip_compatible</span><span class="o">=</span><span class="n">pip_compatible</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_modifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="BaseRecipe.extract_downloads_to"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.extract_downloads_to">[docs]</a>    <span class="k">def</span> <span class="nf">extract_downloads_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span> <span class="n">outconf_name</span><span class="o">=</span><span class="s1">&#39;release.cfg&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract anything that has been downloaded to target_dir.</span>

<span class="sd">        This doesn&#39;t copy intermediary buildout configurations nor local parts.</span>
<span class="sd">        In the purpose of making a self-contained and offline playable archive,</span>
<span class="sd">        these are assumed to be already taken care of.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting part </span><span class="si">%r</span><span class="s2"> to directory </span><span class="si">%r</span><span class="s2"> and config file </span><span class="si">%r</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;therein.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span> <span class="n">outconf_name</span><span class="p">)</span>
        <span class="n">target_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
        <span class="n">out_conf</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>

        <span class="n">all_extracted</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="p">,</span> <span class="s1">&#39;_odoo_recipe_extracted&#39;</span><span class="p">,</span>
                                <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">all_extracted</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_extracted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="o">.</span><span class="n">_odoo_recipe_extracted</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out_config_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">outconf_name</span><span class="p">)</span>

        <span class="c1"># GR TODO this will fail if same target dir has been used with</span>
        <span class="c1"># a different outconf_name</span>
        <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">in</span> <span class="n">all_extracted</span><span class="p">:</span>
            <span class="c1"># read configuration started by other recipe</span>
            <span class="n">out_conf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">out_config_path</span><span class="p">)</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">all_extracted</span><span class="p">[</span><span class="n">target_dir</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_extracted_buildout</span><span class="p">(</span><span class="n">out_conf</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">all_extracted</span><span class="p">[</span><span class="n">target_dir</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_egg_versions</span><span class="p">(</span><span class="n">out_conf</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_sources</span><span class="p">(</span><span class="n">out_conf</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span> <span class="n">extracted</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_config_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out_conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_extract_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_conf</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span> <span class="n">extracted</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Core extraction method.</span>

<span class="sd">        out_conf is a ConfigParser instance to write to</span>
<span class="sd">        extracted is a technical set used to know what targets have already</span>
<span class="sd">        been written by previous parts and store for subsequent ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
        <span class="n">conf_ensure_section</span><span class="p">(</span><span class="n">out_conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># remove bzr extra if needed</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;recipe&#39;</span><span class="p">]</span>
        <span class="n">pkg_extras</span><span class="p">,</span> <span class="n">recipe_cls</span> <span class="o">=</span> <span class="n">recipe</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">extra_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(.*?)\[(.*?)\]&#39;</span><span class="p">,</span> <span class="n">pkg_extras</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">recipe_pkg</span> <span class="o">=</span> <span class="n">extra_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">extras</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extra_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
            <span class="n">extras</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="s1">&#39;bzr&#39;</span><span class="p">)</span>
            <span class="n">extracted_recipe</span> <span class="o">=</span> <span class="n">recipe_pkg</span>
            <span class="k">if</span> <span class="n">extras</span><span class="p">:</span>
                <span class="n">extracted_recipe</span> <span class="o">+=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extras</span><span class="p">)</span>
            <span class="n">extracted_recipe</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">recipe_cls</span>
            <span class="n">out_conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;recipe&#39;</span><span class="p">,</span> <span class="n">extracted_recipe</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;recipe&#39;</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span>

        <span class="n">addons_option</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">source_type</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">local_path</span> <span class="ow">is</span> <span class="n">main_software</span><span class="p">:</span>
                <span class="n">rel_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_main_software</span><span class="p">(</span><span class="n">source_type</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span>
                                                       <span class="n">extracted</span><span class="p">)</span>
                <span class="n">out_conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;local &#39;</span> <span class="o">+</span> <span class="n">rel_path</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># stripping the group option that won&#39;t be usefult</span>
            <span class="c1"># and actually harming for extracted buildout conf</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">target_local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">target_local_path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Inconsistent configuration that &quot;</span>
                        <span class="s2">&quot;should not happen: group=</span><span class="si">%r</span><span class="s2">, but resulting path </span><span class="si">%r</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;does not have it as its parent&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">local_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_local_path</span> <span class="o">=</span> <span class="n">local_path</span>

            <span class="n">addons_line</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">target_local_path</span><span class="p">]</span>
            <span class="n">addons_line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">addons_option</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">addons_line</span><span class="p">))</span>

            <span class="n">abspath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s1">&#39;downloadable&#39;</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">local_path</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">source_type</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>  <span class="c1"># vcs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extract_vcs_source</span><span class="p">(</span><span class="n">source_type</span><span class="p">,</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span>
                                         <span class="n">local_path</span><span class="p">,</span> <span class="n">extracted</span><span class="p">)</span>
        <span class="c1"># remove duplicates preserving order</span>
        <span class="n">addons_option</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">addons_option</span><span class="p">))</span>
        <span class="n">out_conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;addons&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">addons_option</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;revisions&#39;</span><span class="p">):</span>
            <span class="n">out_conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;revisions&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># GR hacky way to make a comment for a void value. Indeed,</span>
            <span class="c1"># &quot;revisions = ; comment&quot; is not recognized as an inline comment</span>
            <span class="c1"># because of overall stripping and a need for whitespace before</span>
            <span class="c1"># the semicolon (sigh)</span>
            <span class="n">out_conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;; about revisions&#39;</span><span class="p">,</span>
                         <span class="s2">&quot;the extended buildout &#39;</span><span class="si">%s</span><span class="s2">&#39; uses the &#39;revisions&#39; &quot;</span>
                         <span class="s2">&quot;option. The present override disables it &quot;</span>
                         <span class="s2">&quot;because it makes no sense after extraction and &quot;</span>
                         <span class="s2">&quot;replacement by the &quot;</span>
                         <span class="s2">&quot;&#39;local&#39; scheme&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout_cfg_name</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_extract_vcs_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vcs_type</span><span class="p">,</span> <span class="n">repo_path</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span>
                            <span class="n">extracted</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a VCS source.</span>

<span class="sd">        The extracted argument is a set of previously extracted targets.</span>
<span class="sd">        This is because some VCS will refuse an empty directory (bzr does)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">repo_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_absolute</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span>
        <span class="n">target_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_path</span> <span class="ow">in</span> <span class="n">extracted</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">repo</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">.</span><span class="n">repo</span><span class="p">(</span><span class="n">vcs_type</span><span class="p">,</span> <span class="n">repo_path</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># no need of remote URL</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">archive</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>
        <span class="n">extracted</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_main_software</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_type</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span> <span class="n">extracted</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the main software to target_dir and return relative path.</span>

<span class="sd">        As this is for extract_downloads_to, local main software is not</span>
<span class="sd">        extracted (supposed to be taken care of by the tool that does the</span>
<span class="sd">        archival of buildout dir itself).</span>

<span class="sd">        The extracted set avoids extracting twice to same target (refused</span>
<span class="sd">        by some VCSes anyway)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildout_dir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Main odoo directory </span><span class="si">%r</span><span class="s2"> outside of buildout &quot;</span>
                <span class="s2">&quot;directory, don&#39;t know how to handle that&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">)</span>

        <span class="n">local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildout_dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):]</span>
        <span class="n">target_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_path</span> <span class="ow">in</span> <span class="n">extracted</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">local_path</span>

        <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s1">&#39;downloadable&#39;</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">source_type</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>  <span class="c1"># see docstring for &#39;local&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_vcs_source</span><span class="p">(</span><span class="n">source_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">,</span>
                                     <span class="n">local_path</span><span class="p">,</span> <span class="n">extracted</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">local_path</span>

    <span class="k">def</span> <span class="nf">_prepare_extracted_buildout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the &#39;buildout&#39; section in ``conf``.</span>

<span class="sd">        Also takes care of gp.vcsdevelop driven distributions.</span>

<span class="sd">        In most cases, at this stage, gp.vcsdevelop and regular develop</span>
<span class="sd">        distributions are expressed with absolute paths. This method will make</span>
<span class="sd">        them local in the destination ``conf``</span>

<span class="sd">        Regular develop distributions pointing outside of buildout directory</span>
<span class="sd">        are kept as is, assuming this has been specified in absolute form</span>
<span class="sd">        in the config file, hence to some resources that are outside of</span>
<span class="sd">        the recipe control, that are therefore expected to be deployed before</span>
<span class="sd">        hand on target systems.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;buildout&#39;</span><span class="p">)</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;buildout&#39;</span><span class="p">,</span> <span class="s1">&#39;extends&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout_cfg_name</span><span class="p">())</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s1">&#39;versions&#39;</span><span class="p">)</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;buildout&#39;</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">)</span>

        <span class="n">develops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">option_splitlines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;develop&#39;</span><span class="p">)))</span>

        <span class="n">extracted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">raw</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">,</span> <span class="n">abs_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gp_vcs_develops</span><span class="p">():</span>
            <span class="n">target_sub_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">vcs_type</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_vcs_source</span><span class="p">(</span><span class="n">vcs_type</span><span class="p">,</span> <span class="n">abs_path</span><span class="p">,</span>
                                     <span class="n">target_dir</span><span class="p">,</span> <span class="n">target_sub_dir</span><span class="p">,</span> <span class="n">extracted</span><span class="p">)</span>
            <span class="c1"># looks silly, but better for uniformity:</span>
            <span class="n">develops</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target_sub_dir</span><span class="p">)</span>

        <span class="n">bdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildout_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;buildout&#39;</span><span class="p">,</span> <span class="s1">&#39;develop&#39;</span><span class="p">,</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bdir</span><span class="p">):]</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">bdir</span><span class="p">)</span> <span class="k">else</span> <span class="n">d</span>
                                 <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">develops</span><span class="p">))</span>

        <span class="c1"># remove gp.vcsdevelop from extensions</span>
        <span class="n">exts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildout</span><span class="p">[</span><span class="s1">&#39;buildout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extensions&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;gp.vcsdevelop&#39;</span> <span class="ow">in</span> <span class="n">exts</span><span class="p">:</span>
            <span class="n">exts</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;gp.vcsdevelop&#39;</span><span class="p">)</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;buildout&#39;</span><span class="p">,</span> <span class="s1">&#39;extensions&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exts</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_install_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Install and register a scripbont with prescribed name and content.</span>

<span class="sd">        Return the script path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">odoo_installed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_install_startup_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_create_default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="n">update</span> <span class="o">=</span> <span class="n">install</span>

    <span class="k">def</span> <span class="nf">_default_addons_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the default addons path for OpenERP &gt; 6.0 pure python install</span>

<span class="sd">        Actual implementation is up to subclasses</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BaseRecipe.finalize_addons_paths"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.finalize_addons_paths">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_addons_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_existence</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add implicit paths and serialize in the addons_path option.</span>

<span class="sd">        :param check_existence: if ``True``, all the paths will be checked for</span>
<span class="sd">                                existence (useful for unit tests)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opt_key</span> <span class="o">=</span> <span class="s1">&#39;options.addons_path&#39;</span>
        <span class="k">if</span> <span class="n">opt_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;In part </span><span class="si">%r</span><span class="s2">, direct use of </span><span class="si">%s</span><span class="s2"> is prohibited. &quot;</span>
                            <span class="s2">&quot;please use addons lines with type &#39;local&#39; &quot;</span>
                            <span class="s2">&quot;instead.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">opt_key</span><span class="p">))</span>

        <span class="n">base_addons</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">,</span> <span class="s1">&#39;odoo&#39;</span><span class="p">,</span> <span class="s1">&#39;addons&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_addons</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addons_paths</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_addons</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_odoo_git_addons</span><span class="p">(</span><span class="n">base_addons</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_existence</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">addons_paths</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="p">(</span>
                    <span class="s2">&quot;Not a directory: </span><span class="si">%r</span><span class="s2"> (aborting)&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addons_paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span>
                <span class="n">addons_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative_paths</span>
            <span class="k">else</span> <span class="n">addons_path</span>
            <span class="k">for</span> <span class="n">addons_path</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addons_paths</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;options.addons_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addons_paths</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.insert_odoo_git_addons"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.insert_odoo_git_addons">[docs]</a>    <span class="k">def</span> <span class="nf">insert_odoo_git_addons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_addons</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the standard, non-base addons bundled within Odoo git repo.</span>

<span class="sd">        See `lp:1327756</span>
<span class="sd">        &lt;https://bugs.launchpad.net/anybox.recipe.openerp/+bug/1327756&gt;`_</span>

<span class="sd">        These addons are also part of the Github branch for prior versions,</span>
<span class="sd">        therefore we cannot rely on version knowledge; we check for existence</span>
<span class="sd">        instead.</span>
<span class="sd">        If not found (e.g, we are on a nightly for OpenERP &lt;= 7), this method</span>
<span class="sd">        does nothing.</span>

<span class="sd">        The ordering of the different paths of addons is important.</span>
<span class="sd">        When several addons at different paths have the same name, the first</span>
<span class="sd">        of them being found is used. This can be used, for instance, to</span>
<span class="sd">        replace an official addon by another one by placing a different</span>
<span class="sd">        addons&#39; path before the official one.</span>

<span class="sd">        If the official addons&#39; path is already set in the config file</span>
<span class="sd">        (e.g. at the end), it will leave it at the end of the paths list,</span>
<span class="sd">        if it is not set, it will be placed at the beginning just after</span>
<span class="sd">        ``base`` addons&#39; path.</span>

<span class="sd">        Care is taken not to break configurations that corrected this manually</span>
<span class="sd">        with a ``local`` source in the ``addons`` option.</span>

<span class="sd">        :param base_addons: the path to previously detected ``base`` addons,</span>
<span class="sd">                            to properly insert right after them</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">odoo_git_addons</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">,</span> <span class="s1">&#39;addons&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">odoo_git_addons</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_git_layout</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">addons_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addons_paths</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">insert_at</span> <span class="o">=</span> <span class="n">addons_paths</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">base_addons</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">insert_at</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">addons_paths</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">odoo_git_addons</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">addons_paths</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_at</span><span class="p">,</span> <span class="n">odoo_git_addons</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.cleanup_odoo_dir"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.cleanup_odoo_dir">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_odoo_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Revert local modifications that have been made during installation.</span>

<span class="sd">        These can be, e.g., forbidden by the freeze process.&quot;&quot;&quot;</span>

        <span class="c1"># from here we can&#39;t guess whether it&#39;s &#39;odoo&#39; or &#39;odoo&#39;.</span>
        <span class="c1"># Nothing guarantees that this method is called after develop().</span>
        <span class="c1"># It is in practice now, but one day, the extraction as a separate</span>
        <span class="c1"># script of freeze/extract will become a reality.</span>
        <span class="k">for</span> <span class="n">proj_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;openerp&#39;</span><span class="p">,</span> <span class="s1">&#39;odoo&#39;</span><span class="p">):</span>
            <span class="n">egg_info_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odoo_dir</span><span class="p">,</span> <span class="n">proj_name</span> <span class="o">+</span> <span class="s1">&#39;.egg-info&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">egg_info_dir</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">egg_info_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseRecipe.buildout_cfg_name"><a class="viewcode-back" href="../../../../apidoc/oca.recipe.odoo.html#oca.recipe.odoo.base.BaseRecipe.buildout_cfg_name">[docs]</a>    <span class="k">def</span> <span class="nf">buildout_cfg_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of the config file that&#39;s been called.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># not using optparse because it&#39;s not obvious how to tell it to</span>
        <span class="c1"># consider just one option and ignore the others.</span>

        <span class="k">if</span> <span class="n">argv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># -c FILE or --config FILE syntax</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--config&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># --config=FILE syntax</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;--config=&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">argv</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>

        <span class="k">return</span> <span class="s1">&#39;buildout.cfg&#39;</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2011-2021, &lt;a href=&#34;http://anybox.fr/&#34;&gt;Anybox SAS&lt;/a&gt;; 2021 &lt;a href=&#34;https://odoo-community.org/&#34;&gt;Odoo Community Association&lt;/a&gt; and contributors.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>